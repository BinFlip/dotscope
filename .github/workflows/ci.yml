name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"
  DOTNET_NOLOGO: "true"

jobs:
  # Library testing and linting - no build artifacts needed
  check:
    name: Check & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Warm up .NET SDK
      run: |
        dotnet --info
        dotnet new console -n warmup -o ${{ runner.temp }}/warmup
        dotnet build ${{ runner.temp }}/warmup

    - name: Install Mono and Z3 (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y mono-utils libz3-dev

    - name: Install Mono and Z3 (macOS)
      if: runner.os == 'macOS'
      run: brew install mono z3

    - name: Install Z3 and dotnet-ildasm tool (Windows)
      if: runner.os == 'Windows'
      run: |
        dotnet tool install --global dotnet-ildasm
        # Download Z3 from GitHub releases (more reliable than Chocolatey)
        $z3Version = "4.13.4"
        $z3Url = "https://github.com/Z3Prover/z3/releases/download/z3-$z3Version/z3-$z3Version-x64-win.zip"
        $z3Zip = "$env:RUNNER_TEMP\z3.zip"
        $z3Dir = "$env:RUNNER_TEMP\z3"
        Invoke-WebRequest -Uri $z3Url -OutFile $z3Zip
        Expand-Archive -Path $z3Zip -DestinationPath $z3Dir
        $z3Root = Get-ChildItem -Path $z3Dir -Directory | Select-Object -First 1
        echo "Z3_SYS_Z3_HEADER=$(Join-Path $z3Root.FullName 'include\z3.h')" >> $env:GITHUB_ENV
        echo "LIBZ3_SYS_LIB_DIR=$(Join-Path $z3Root.FullName 'bin')" >> $env:GITHUB_ENV
        # Add Z3 bin to PATH so libz3.dll is found at runtime
        echo "$(Join-Path $z3Root.FullName 'bin')" >> $env:GITHUB_PATH
        echo "Installed Z3 $z3Version at: $($z3Root.FullName)"
        ls (Join-Path $z3Root.FullName 'bin')
      shell: pwsh

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ matrix.os }}-check
        
    - name: Check formatting
      run: cargo fmt --all -- --check
      
    - name: Run clippy
      run: cargo clippy --all-targets -- -D warnings

    - name: Check compilation
      run: cargo check

    - name: Run tests (Linux - full)
      if: runner.os == 'Linux'
      run: cargo test --release --lib --verbose

    - name: Run tests (macOS/Windows - skip expensive tests)
      if: runner.os != 'Linux'
      run: cargo test --release --lib --features skip-expensive-tests --verbose

    - name: Run doc tests (Linux only)
      if: runner.os == 'Linux'
      run: cargo test --release --doc

    - name: Check documentation
      run: cargo doc --no-deps

  # Ensures the crate compiles and tests pass without legacy-crypto feature (Linux only)
  minimal-features:
    name: Minimal Features
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: minimal-features

    - name: Check compilation (no default features)
      run: cargo check --no-default-features

    - name: Run tests (no default features)
      run: cargo test --no-default-features --release --verbose

  # Fuzzing on pushes to master or PRs targeting master
  fuzzing:
    name: Quick Fuzzing
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'master') ||
      contains(github.event.head_commit.message, '[fuzz]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly
      
    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz
      
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: fuzz-quick
        
    - name: Build fuzz target
      run: cargo +nightly fuzz build --release cilobject
      working-directory: fuzz

    - name: Run quick fuzz test
      run: timeout 60 cargo +nightly fuzz run cilobject --release -- -max_total_time=50 || true
      working-directory: fuzz
        
    - name: Check for crashes
      run: |
        if [ -d "fuzz/artifacts/cilobject" ] && [ "$(ls -A fuzz/artifacts/cilobject)" ]; then
          echo "Fuzzing found crashes!"
          ls -la fuzz/artifacts/cilobject/
          exit 1
        fi

  # Security audit on pushes to master or PRs targeting master
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install cargo-audit
      run: cargo install cargo-audit
      
    - name: Run security audit
      run: cargo audit

  # Code coverage
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview
        
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Warm up .NET SDK
      run: |
        dotnet --info
        dotnet new console -n warmup -o ${{ runner.temp }}/warmup
        dotnet build ${{ runner.temp }}/warmup

    - name: Install Mono and Z3
      run: |
        sudo apt-get update
        sudo apt-get install -y mono-utils libz3-dev

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: coverage
        
    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov
      
    - name: Generate code coverage
      run: cargo llvm-cov --workspace --features skip-expensive-tests --lcov --output-path lcov.info
      
    - name: Upload to codecov.io
      uses: codecov/codecov-action@v5
      with:
        files: lcov.info
        fail_ci_if_error: true
        token: ${{ secrets.CODECOV_TOKEN }}
